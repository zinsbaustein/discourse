_default: &default
  first_thing:
    - command: apt-get update
      target: rails
      sudo: true
      run_on: all_servers

    - command: apt-get install --yes gcc build-essential libxslt-dev libxml2-dev zlib1g-dev libpq-dev imagemagick
        brotli pngcrush pngquant jhead jpegoptim postgresql-client
      target: rails
      sudo: true
      run_on: all_servers

  after_node:
    # Required for assets:precompile to work (for ES6 support).
    - command: npm install -g terser
      target: rails
      sudo: true
      run_on: all_servers

  after_bundle:
    # Without the dev dependencies, patch-package can't be found (run on postinstall in package.json).
    - command: cd $STACK_PATH && yarn install --production=false --frozen-lockfile && yarn cache clean
      target: rails
      run_on: all_servers

    - command: cd $STACK_PATH && bundle exec rake db:create && bundle exec rake db:migrate
      target: rails
      run_on: all_servers
      apply_during: build_only

    - command: cd $STACK_PATH && LOAD_PLUGINS=0 bundle exec rake plugin:pull_compatible_all
      target: rails
      run_on: all_servers

    - command: cd $STACK_PATH && bundle exec rake assets:precompile:build
      target: rails
      run_on: all_servers

    - command: cd $STACK_PATH && SKIP_EMBER_CLI_COMPILE=1 bundle exec rake themes:update assets:precompile
      target: rails
      run_on: all_servers

production:
  <<: *default

staging:
  <<: *default
